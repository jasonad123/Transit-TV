name: Cleanup untagged Docker images

on:
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sunday at 2 AM UTC
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Preview deletions without executing'
        type: boolean
        default: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/transit-tv

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      packages: write

    steps:
      - name: Cleanup untagged versions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
        run: |
          set -euo pipefail

          echo "================================="
          echo "Untagged Docker Image Cleanup Started"
          echo "================================="
          echo "Registry: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          echo "Dry Run: ${DRY_RUN}"
          echo ""

          # Fetch all package versions
          echo "Fetching package versions..."
          VERSIONS=$(gh api --paginate \
            "/users/${{ github.repository_owner }}/packages/container/transit-tv/versions")

          # Process versions to extract needed fields
          VERSIONS=$(echo "$VERSIONS" | jq -s 'flatten | [.[] | {
            id: .id,
            name: .name,
            tags: (.metadata?.container?.tags // []),
            created_at: .created_at
          }]')

          TOTAL_COUNT=$(echo "$VERSIONS" | jq 'length')
          echo "Total versions found: $TOTAL_COUNT"
          echo ""

          # Process untagged versions (sha256 digests, platform manifests)
          echo "================================="
          echo "Processing Untagged Versions"
          echo "================================="

          UNTAGGED_VERSIONS=$(echo "$VERSIONS" | jq '[.[] | select(.tags | length == 0)] | sort_by(.created_at) | reverse')
          UNTAGGED_COUNT=$(echo "$UNTAGGED_VERSIONS" | jq 'length')
          echo "Found $UNTAGGED_COUNT untagged versions (sha256 digests, platform manifests)"

          if [ "$UNTAGGED_COUNT" -gt 0 ]; then
            echo "Deleting all untagged versions to clean up manifest clutter"
            echo ""

            echo "$UNTAGGED_VERSIONS" | jq -c '.[]' | while IFS= read -r version; do
              VERSION_ID=$(echo "$version" | jq -r '.id')
              VERSION_NAME=$(echo "$version" | jq -r '.name')
              VERSION_DATE=$(echo "$version" | jq -r '.created_at')

              if [ "${DRY_RUN}" == "true" ]; then
                echo "[DRY RUN] Would delete untagged: $VERSION_ID (name: $VERSION_NAME, created: $VERSION_DATE)"
              else
                echo "Deleting untagged: $VERSION_ID (name: $VERSION_NAME)"
                if gh api -X DELETE \
                  "/users/${{ github.repository_owner }}/packages/container/transit-tv/versions/$VERSION_ID" 2>&1; then
                  echo "  Successfully deleted"
                else
                  echo "  Failed to delete version $VERSION_ID"
                fi
              fi
            done
          else
            echo "No untagged versions to delete"
          fi
          echo ""

          echo "================================="
          echo "Cleanup Complete"
          echo "================================="

          if [ "${DRY_RUN}" == "true" ]; then
            echo "DRY RUN MODE: No versions were actually deleted"
            echo "Run with dry_run=false to execute deletions"
          fi
