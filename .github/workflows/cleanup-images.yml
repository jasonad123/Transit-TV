name: Cleanup Old Docker Images

on:
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sunday at 2 AM UTC
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Preview deletions without executing'
        type: boolean
        default: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/transit-tv
  KEEP_BETA_COUNT: 3
  KEEP_EDGE_COUNT: 2

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      packages: write

    steps:
      - name: Cleanup beta and edge versions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
        run: |
          set -euo pipefail

          echo "================================="
          echo "Docker Image Cleanup Started"
          echo "================================="
          echo "Registry: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          echo "Dry Run: ${DRY_RUN}"
          echo "Keep Beta: ${{ env.KEEP_BETA_COUNT }}"
          echo "Keep Edge: ${{ env.KEEP_EDGE_COUNT }}"
          echo ""

          # Fetch all package versions
          echo "Fetching package versions..."
          # Note: --paginate returns each page as a separate JSON array
          # We need to combine them properly
          VERSIONS=$(gh api --paginate \
            "/users/${{ github.repository_owner }}/packages/container/transit-tv/versions" | \
            jq -s 'add // []')

          # Debug: Show raw API response structure
          echo "DEBUG: Raw API response (first 500 chars):"
          echo "$VERSIONS" | head -c 500
          echo ""
          echo ""

          # Process versions to extract needed fields with safe navigation
          VERSIONS=$(echo "$VERSIONS" | jq '[.[] | {
            id: .id,
            name: .name,
            tags: (try (.metadata.container.tags // []) catch []),
            created_at: .created_at
          }]')

          # Debug: Show processed version structure
          echo "DEBUG: Processed first version structure:"
          echo "$VERSIONS" | jq -r '.[0]'
          echo ""

          TOTAL_COUNT=$(echo "$VERSIONS" | jq 'length')
          echo "Total versions found: $TOTAL_COUNT"
          echo ""

          # Function to check if version has protected tag
          is_protected_version() {
            local version_json="$1"
            local tags=$(echo "$version_json" | jq -r '.tags[]?' 2>/dev/null || echo "")

            if [ -z "$tags" ]; then
              return 1  # No tags = not protected
            fi

            while IFS= read -r tag; do
              # Preserve: latest, beta, edge, pre-release, semantic versions
              if [[ "$tag" == "latest" ]] || \
                 [[ "$tag" == "beta" ]] || \
                 [[ "$tag" == "edge" ]] || \
                 [[ "$tag" == "pre-release" ]] || \
                 [[ "$tag" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+ ]]; then
                echo "  Protected tag found: $tag"
                return 0
              fi
            done <<< "$tags"

            return 1
          }

          # Process beta versions (beta-{branch}-{sha})
          echo "================================="
          echo "Processing Beta Versions"
          echo "================================="

          BETA_VERSIONS=$(echo "$VERSIONS" | jq '[.[] | select(.tags | any(. != null and startswith("beta-")))] |
            unique_by(.id) |
            sort_by(.created_at) |
            reverse')

          BETA_COUNT=$(echo "$BETA_VERSIONS" | jq 'length')
          echo "Found $BETA_COUNT beta versions"

          if [ "$BETA_COUNT" -gt "${{ env.KEEP_BETA_COUNT }}" ]; then
            TO_DELETE_COUNT=$((BETA_COUNT - ${{ env.KEEP_BETA_COUNT }}))
            echo "Keeping ${{ env.KEEP_BETA_COUNT }} most recent, deleting $TO_DELETE_COUNT oldest"
            echo ""

            echo "$BETA_VERSIONS" | jq -c ".[${{ env.KEEP_BETA_COUNT }}:][]" | while IFS= read -r version; do
              VERSION_ID=$(echo "$version" | jq -r '.id')
              VERSION_TAGS=$(echo "$version" | jq -r '.tags[]?' | tr '\n' ' ')
              VERSION_DATE=$(echo "$version" | jq -r '.created_at')

              # Double-check protection
              if is_protected_version "$version"; then
                echo "SKIPPING protected version: $VERSION_ID (tags: $VERSION_TAGS)"
                continue
              fi

              if [ "${DRY_RUN}" == "true" ]; then
                echo "[DRY RUN] Would delete: $VERSION_ID (tags: $VERSION_TAGS, created: $VERSION_DATE)"
              else
                echo "Deleting: $VERSION_ID (tags: $VERSION_TAGS)"
                if gh api -X DELETE \
                  "/users/${{ github.repository_owner }}/packages/container/transit-tv/versions/$VERSION_ID" 2>&1; then
                  echo "  Successfully deleted"
                else
                  echo "  Failed to delete version $VERSION_ID"
                fi
              fi
            done
          else
            echo "No beta versions to delete (within retention limit)"
          fi
          echo ""

          # Process edge versions (edge-{sha})
          echo "================================="
          echo "Processing Edge Versions"
          echo "================================="

          EDGE_VERSIONS=$(echo "$VERSIONS" | jq '[.[] | select(.tags | any(. != null and startswith("edge-")))] |
            unique_by(.id) |
            sort_by(.created_at) |
            reverse')

          EDGE_COUNT=$(echo "$EDGE_VERSIONS" | jq 'length')
          echo "Found $EDGE_COUNT edge versions"

          if [ "$EDGE_COUNT" -gt "${{ env.KEEP_EDGE_COUNT }}" ]; then
            TO_DELETE_COUNT=$((EDGE_COUNT - ${{ env.KEEP_EDGE_COUNT }}))
            echo "Keeping ${{ env.KEEP_EDGE_COUNT }} most recent, deleting $TO_DELETE_COUNT oldest"
            echo ""

            echo "$EDGE_VERSIONS" | jq -c ".[${{ env.KEEP_EDGE_COUNT }}:][]" | while IFS= read -r version; do
              VERSION_ID=$(echo "$version" | jq -r '.id')
              VERSION_TAGS=$(echo "$version" | jq -r '.tags[]?' | tr '\n' ' ')
              VERSION_DATE=$(echo "$version" | jq -r '.created_at')

              # Double-check protection
              if is_protected_version "$version"; then
                echo "SKIPPING protected version: $VERSION_ID (tags: $VERSION_TAGS)"
                continue
              fi

              if [ "${DRY_RUN}" == "true" ]; then
                echo "[DRY RUN] Would delete: $VERSION_ID (tags: $VERSION_TAGS, created: $VERSION_DATE)"
              else
                echo "Deleting: $VERSION_ID (tags: $VERSION_TAGS)"
                if gh api -X DELETE \
                  "/users/${{ github.repository_owner }}/packages/container/transit-tv/versions/$VERSION_ID" 2>&1; then
                  echo "  Successfully deleted"
                else
                  echo "  Failed to delete version $VERSION_ID"
                fi
              fi
            done
          else
            echo "No edge versions to delete (within retention limit)"
          fi
          echo ""

          # Process branch-test versions (manual workflow_dispatch builds)
          echo "================================="
          echo "Processing Branch-Test Versions"
          echo "================================="

          # Find versions with tags that don't match beta-*, edge-*, or protected patterns
          BRANCH_TEST_VERSIONS=$(echo "$VERSIONS" | jq '[.[] |
            select(.tags | length > 0) |
            select(.tags | any(
              (startswith("beta-") or startswith("edge-") or
               . == "latest" or . == "beta" or . == "edge" or . == "pre-release" or
               test("^v?[0-9]+\\.[0-9]+\\.[0-9]+")) | not)) |
            select(.tags | any(test("-[a-f0-9]{7}$"))) |
            unique_by(.id)')

          BRANCH_TEST_COUNT=$(echo "$BRANCH_TEST_VERSIONS" | jq 'length')
          echo "Found $BRANCH_TEST_COUNT branch-test versions"

          if [ "$BRANCH_TEST_COUNT" -gt 0 ]; then
            echo ""
            echo "$BRANCH_TEST_VERSIONS" | jq -c '.[]' | while IFS= read -r version; do
              VERSION_ID=$(echo "$version" | jq -r '.id')
              VERSION_TAGS=$(echo "$version" | jq -r '.tags[]?' | tr '\n' ' ')
              VERSION_DATE=$(echo "$version" | jq -r '.created_at')

              # Double-check protection
              if is_protected_version "$version"; then
                echo "SKIPPING protected version: $VERSION_ID (tags: $VERSION_TAGS)"
                continue
              fi

              if [ "${DRY_RUN}" == "true" ]; then
                echo "[DRY RUN] Would delete: $VERSION_ID (tags: $VERSION_TAGS, created: $VERSION_DATE)"
              else
                echo "Deleting: $VERSION_ID (tags: $VERSION_TAGS)"
                if gh api -X DELETE \
                  "/users/${{ github.repository_owner }}/packages/container/transit-tv/versions/$VERSION_ID" 2>&1; then
                  echo "  Successfully deleted"
                else
                  echo "  Failed to delete version $VERSION_ID"
                fi
              fi
            done
          else
            echo "No branch-test versions to delete"
          fi
          echo ""

          # Process untagged versions (sha256 digests, platform manifests)
          echo "================================="
          echo "Processing Untagged Versions"
          echo "================================="

          UNTAGGED_VERSIONS=$(echo "$VERSIONS" | jq '[.[] | select(.tags | length == 0)] | sort_by(.created_at) | reverse')
          UNTAGGED_COUNT=$(echo "$UNTAGGED_VERSIONS" | jq 'length')
          echo "Found $UNTAGGED_COUNT untagged versions (sha256 digests, platform manifests)"

          if [ "$UNTAGGED_COUNT" -gt 0 ]; then
            echo "Deleting all untagged versions to clean up manifest clutter"
            echo ""

            echo "$UNTAGGED_VERSIONS" | jq -c '.[]' | while IFS= read -r version; do
              VERSION_ID=$(echo "$version" | jq -r '.id')
              VERSION_NAME=$(echo "$version" | jq -r '.name')
              VERSION_DATE=$(echo "$version" | jq -r '.created_at')

              if [ "${DRY_RUN}" == "true" ]; then
                echo "[DRY RUN] Would delete untagged: $VERSION_ID (name: $VERSION_NAME, created: $VERSION_DATE)"
              else
                echo "Deleting untagged: $VERSION_ID (name: $VERSION_NAME)"
                if gh api -X DELETE \
                  "/users/${{ github.repository_owner }}/packages/container/transit-tv/versions/$VERSION_ID" 2>&1; then
                  echo "  Successfully deleted"
                else
                  echo "  Failed to delete version $VERSION_ID"
                fi
              fi
            done
          else
            echo "No untagged versions to delete"
          fi
          echo ""

          echo "================================="
          echo "Cleanup Complete"
          echo "================================="

          if [ "${DRY_RUN}" == "true" ]; then
            echo "DRY RUN MODE: No versions were actually deleted"
            echo "Run with dry_run=false to execute deletions"
          fi
