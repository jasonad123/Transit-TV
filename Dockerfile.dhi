# ==============================================================================
# Docker Hardened Images (DHI) Dockerfile
# ==============================================================================
# This version uses Docker's hardened images for enhanced security
#
# Benefits:
# - Up to 95% smaller attack surface
# - Near-zero CVEs maintained by Docker
# - Free and open source (Apache 2.0)
#
# Requirements:
# - Docker Hub authentication: docker login dhi.io
# - Use your Docker Hub credentials
#
# To build: docker build -f Dockerfile.dhi -t transit-tv:dhi .
# ==============================================================================

# Builder stage - use -dev variant for build tools
FROM dhi.io/node:24-alpine3.22-dev AS builder

WORKDIR /app

# Enable corepack (bundled with Node 24+)
RUN corepack enable && corepack prepare pnpm@latest --activate

# Copy dependency files first for better layer caching
COPY package.json pnpm-lock.yaml ./
COPY svelte-app/package.json svelte-app/pnpm-lock.yaml svelte-app/pnpm-workspace.yaml ./svelte-app/

# Install root dependencies with cache mount for faster rebuilds
RUN --mount=type=cache,target=/root/.local/share/pnpm/store \
    pnpm install --frozen-lockfile

# Install svelte-app dependencies with cache mount
WORKDIR /app/svelte-app
RUN --mount=type=cache,target=/root/.local/share/pnpm/store \
    pnpm install --frozen-lockfile

# Copy source code (only rebuilds when source changes)
WORKDIR /app
COPY svelte-app ./svelte-app
COPY server ./server

# Build the SvelteKit application
RUN cd svelte-app && pnpm run build

# ==============================================================================
# Production stage - hardened runtime image
# ==============================================================================
FROM dhi.io/node:24-alpine3.22

WORKDIR /app

# Enable corepack for pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

# Copy only what's needed for runtime
COPY --from=builder /app/svelte-app/build ./svelte-app/build
COPY --from=builder /app/server ./server
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/pnpm-lock.yaml ./pnpm-lock.yaml

# Install only production dependencies with cache mount
RUN --mount=type=cache,target=/root/.local/share/pnpm/store \
    pnpm install --prod --frozen-lockfile

# Environment configuration
ENV NODE_ENV=production
ENV PORT=8080
ENV USE_SVELTE=true

EXPOSE 8080

# Run as non-root user for security
USER node

# Start with heap size limit for stability
CMD ["node", "--max-old-space-size=400", "server/app.js"]
